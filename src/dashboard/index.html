<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SkyMart Fraud Detection Center</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* ------------------------------------------------------------------ */
    /*  CSS Reset & Variables                                              */
    /* ------------------------------------------------------------------ */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary:   #0f1117;
      --bg-card:      #1a1d2e;
      --bg-card-alt:  #222640;
      --bg-input:     #2a2e42;
      --border:       #2e3348;
      --text-primary: #e8eaf0;
      --text-secondary: #9ca3af;
      --text-muted:   #6b7280;
      --accent-red:   #e74c3c;
      --accent-orange:#f39c12;
      --accent-deep-orange: #e67e22;
      --accent-green: #2ecc71;
      --accent-blue:  #3b82f6;
      --accent-purple:#8b5cf6;
      --font-mono:    'SF Mono', 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
      --font-sans:    -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      --radius:       8px;
      --radius-lg:    12px;
      --shadow:       0 4px 24px rgba(0,0,0,0.3);
      --transition:   all 0.2s ease;
    }

    html { font-size: 14px; }
    body {
      font-family: var(--font-sans);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ------------------------------------------------------------------ */
    /*  Scrollbar                                                          */
    /* ------------------------------------------------------------------ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* ------------------------------------------------------------------ */
    /*  Layout                                                             */
    /* ------------------------------------------------------------------ */
    .container { max-width: 1440px; margin: 0 auto; padding: 0 24px 48px; }

    /* ------------------------------------------------------------------ */
    /*  Header                                                             */
    /* ------------------------------------------------------------------ */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 14px; }
    .header h1 { font-size: 1.25rem; font-weight: 700; letter-spacing: -0.02em; }
    .header-right { display: flex; align-items: center; gap: 20px; font-size: 0.85rem; color: var(--text-secondary); }

    .live-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .live-indicator.connected { background: rgba(46,204,113,0.15); color: var(--accent-green); }
    .live-indicator.disconnected { background: rgba(231,76,60,0.15); color: var(--accent-red); }
    .live-dot {
      width: 8px; height: 8px; border-radius: 50%;
      display: inline-block;
    }
    .live-dot.connected { background: var(--accent-green); animation: pulse-green 2s infinite; }
    .live-dot.disconnected { background: var(--accent-red); }

    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 0 0 rgba(46,204,113,0.5); }
      50% { box-shadow: 0 0 0 6px rgba(46,204,113,0); }
    }

    .shield-icon {
      width: 28px; height: 28px;
      fill: var(--accent-red);
    }

    /* ------------------------------------------------------------------ */
    /*  KPI Cards                                                          */
    /* ------------------------------------------------------------------ */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin: 24px 0;
    }
    .kpi-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px 24px;
      transition: var(--transition);
    }
    .kpi-card:hover { border-color: var(--accent-blue); transform: translateY(-1px); }
    .kpi-label { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
    .kpi-value { font-size: 2rem; font-weight: 700; font-family: var(--font-mono); }
    .kpi-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }

    /* ------------------------------------------------------------------ */
    /*  Charts                                                             */
    /* ------------------------------------------------------------------ */
    .charts-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
    }
    .chart-card h3 { font-size: 0.9rem; margin-bottom: 16px; color: var(--text-secondary); }
    .chart-wrapper { position: relative; height: 260px; }

    /* ------------------------------------------------------------------ */
    /*  Entity Tables (Top Suspicious)                                     */
    /* ------------------------------------------------------------------ */
    .entities-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .entity-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
    }
    .entity-card h3 { font-size: 0.9rem; margin-bottom: 12px; color: var(--text-secondary); }
    .entity-table { width: 100%; border-collapse: collapse; }
    .entity-table th {
      text-align: left;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      padding: 6px 8px;
      border-bottom: 1px solid var(--border);
    }
    .entity-table td {
      padding: 8px;
      font-size: 0.82rem;
      border-bottom: 1px solid rgba(46,51,72,0.5);
      font-family: var(--font-mono);
    }
    .entity-table tr:last-child td { border-bottom: none; }
    .entity-count {
      display: inline-block;
      background: rgba(231,76,60,0.15);
      color: var(--accent-red);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* ------------------------------------------------------------------ */
    /*  Alerts Queue                                                       */
    /* ------------------------------------------------------------------ */
    .alerts-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
    }
    .alerts-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .alerts-header h2 { font-size: 1.1rem; }

    .filter-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .filter-bar select, .filter-bar input[type="range"] {
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 6px 12px;
      border-radius: var(--radius);
      font-size: 0.82rem;
      outline: none;
    }
    .filter-bar select:focus, .filter-bar input:focus { border-color: var(--accent-blue); }
    .filter-bar label { font-size: 0.8rem; color: var(--text-secondary); }
    .risk-slider-value { font-family: var(--font-mono); font-size: 0.8rem; color: var(--accent-orange); min-width: 28px; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 0.82rem;
      cursor: pointer;
      transition: var(--transition);
    }
    .btn:hover { background: var(--bg-card-alt); border-color: var(--accent-blue); }
    .btn-sm { padding: 3px 10px; font-size: 0.75rem; }
    .btn-danger { border-color: var(--accent-red); color: var(--accent-red); }
    .btn-danger:hover { background: rgba(231,76,60,0.15); }
    .btn-success { border-color: var(--accent-green); color: var(--accent-green); }
    .btn-success:hover { background: rgba(46,204,113,0.15); }
    .btn-warning { border-color: var(--accent-orange); color: var(--accent-orange); }
    .btn-warning:hover { background: rgba(243,156,18,0.15); }

    /* Alerts Table */
    .alerts-table-wrap { overflow-x: auto; }
    .alerts-table { width: 100%; border-collapse: collapse; min-width: 900px; }
    .alerts-table th {
      text-align: left;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      padding: 10px 10px;
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
    }
    .alerts-table td {
      padding: 10px;
      font-size: 0.82rem;
      border-bottom: 1px solid rgba(46,51,72,0.4);
      vertical-align: middle;
    }
    .alerts-table tbody tr {
      cursor: pointer;
      transition: var(--transition);
    }
    .alerts-table tbody tr:hover { background: var(--bg-card-alt); }
    .alerts-table .mono { font-family: var(--font-mono); font-size: 0.78rem; }

    /* Risk badge */
    .risk-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.78rem;
      font-weight: 700;
      font-family: var(--font-mono);
    }
    .risk-low    { background: rgba(107,114,128,0.2); color: #9ca3af; }
    .risk-medium { background: rgba(243,156,18,0.2);  color: var(--accent-orange); }
    .risk-high   { background: rgba(230,126,34,0.2);  color: var(--accent-deep-orange); }
    .risk-critical {
      background: rgba(231,76,60,0.25);
      color: var(--accent-red);
      animation: pulse-badge 2s infinite;
    }
    @keyframes pulse-badge {
      0%, 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0.4); }
      50% { box-shadow: 0 0 0 4px rgba(231,76,60,0); }
    }

    /* Rule tags */
    .rule-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      margin: 1px 2px;
      background: rgba(59,130,246,0.15);
      color: var(--accent-blue);
      white-space: nowrap;
    }

    /* Status badge */
    .status-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-needs-review   { background: rgba(243,156,18,0.15); color: var(--accent-orange); }
    .status-investigated   { background: rgba(59,130,246,0.15); color: var(--accent-blue); }
    .status-cleared        { background: rgba(46,204,113,0.15); color: var(--accent-green); }
    .status-confirmed-fraud { background: rgba(231,76,60,0.15); color: var(--accent-red); }

    /* Flash animation for new alerts */
    @keyframes flash-row {
      0% { background: rgba(231,76,60,0.3); }
      100% { background: transparent; }
    }
    .flash-new { animation: flash-row 2s ease-out; }

    /* Notification toast */
    .toast-container {
      position: fixed;
      top: 80px;
      right: 24px;
      z-index: 200;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      background: var(--bg-card);
      border: 1px solid var(--accent-red);
      border-left: 4px solid var(--accent-red);
      border-radius: var(--radius);
      padding: 12px 20px;
      font-size: 0.85rem;
      box-shadow: var(--shadow);
      animation: slide-in 0.3s ease-out;
      max-width: 360px;
    }
    .toast-title { font-weight: 700; color: var(--accent-red); margin-bottom: 2px; }
    .toast-body { color: var(--text-secondary); font-size: 0.8rem; }

    @keyframes slide-in {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* ------------------------------------------------------------------ */
    /*  Drill-Down Modal                                                   */
    /* ------------------------------------------------------------------ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 300;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 900px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }
    .modal-header h2 { font-size: 1.1rem; }
    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.4rem;
      cursor: pointer;
      padding: 4px 8px;
      line-height: 1;
    }
    .modal-close:hover { color: var(--text-primary); }
    .modal-body { padding: 24px; }

    /* Modal tabs */
    .modal-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }
    .modal-tab {
      padding: 10px 20px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: var(--transition);
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
    }
    .modal-tab:hover { color: var(--text-primary); }
    .modal-tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
    .modal-tab-content { display: none; }
    .modal-tab-content.active { display: block; }

    /* Detail grid */
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .detail-item { padding: 10px 14px; background: var(--bg-primary); border-radius: var(--radius); }
    .detail-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
    .detail-value { font-size: 0.9rem; font-family: var(--font-mono); word-break: break-all; }

    /* Timeline */
    .timeline { position: relative; padding-left: 24px; }
    .timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border);
    }
    .timeline-item {
      position: relative;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: var(--bg-primary);
      border-radius: var(--radius);
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -20px;
      top: 16px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-blue);
      border: 2px solid var(--bg-card);
    }
    .timeline-time { font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono); }
    .timeline-detail { font-size: 0.82rem; margin-top: 4px; }

    /* Related transactions table inside modal */
    .related-table { width: 100%; border-collapse: collapse; }
    .related-table th {
      text-align: left;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      padding: 8px;
      border-bottom: 1px solid var(--border);
    }
    .related-table td {
      padding: 8px;
      font-size: 0.82rem;
      border-bottom: 1px solid rgba(46,51,72,0.4);
      font-family: var(--font-mono);
    }

    /* Empty / error states */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-muted);
    }
    .empty-state p { margin-top: 8px; font-size: 0.9rem; }
    .error-banner {
      background: rgba(231,76,60,0.1);
      border: 1px solid var(--accent-red);
      border-radius: var(--radius);
      padding: 12px 20px;
      margin: 16px 0;
      font-size: 0.85rem;
      color: var(--accent-red);
      display: none;
    }
    .error-banner.visible { display: block; }

    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ------------------------------------------------------------------ */
    /*  Responsive                                                         */
    /* ------------------------------------------------------------------ */
    @media (max-width: 1024px) {
      .kpi-row { grid-template-columns: repeat(2, 1fr); }
      .charts-row { grid-template-columns: 1fr; }
      .entities-row { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      .kpi-row { grid-template-columns: 1fr; }
      .header { flex-direction: column; gap: 8px; align-items: flex-start; }
      .header-right { width: 100%; justify-content: space-between; }
      .filter-bar { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>

  <!-- ================================================================ -->
  <!--  Header                                                           -->
  <!-- ================================================================ -->
  <header class="header">
    <div class="header-left">
      <svg class="shield-icon" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
      <h1>SkyMart Fraud Detection Center</h1>
    </div>
    <div class="header-right">
      <div id="wsStatus" class="live-indicator disconnected">
        <span id="wsDot" class="live-dot disconnected"></span>
        <span id="wsLabel">Connecting...</span>
      </div>
      <span id="lastUpdated">Last updated: --</span>
    </div>
  </header>

  <!-- Toast notifications -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Error banner -->
  <div class="container">
    <div id="errorBanner" class="error-banner">
      Unable to connect to the API server. Ensure uvicorn is running on localhost:8000.
    </div>

    <!-- ============================================================== -->
    <!--  KPI Cards                                                      -->
    <!-- ============================================================== -->
    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-label">Total Alerts (24h)</div>
        <div class="kpi-value" id="kpiTotal">--</div>
        <div class="kpi-sub">All risk levels</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">High Risk Alerts</div>
        <div class="kpi-value" id="kpiHighRisk" style="color: var(--accent-red)">--</div>
        <div class="kpi-sub">Score >= 80</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Avg Risk Score</div>
        <div class="kpi-value" id="kpiAvgScore">--</div>
        <div class="kpi-sub">Across all alerts</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">WebSocket Status</div>
        <div class="kpi-value" id="kpiWsStatus" style="font-size: 1.1rem; color: var(--text-secondary)">Connecting...</div>
        <div class="kpi-sub" id="kpiWsSub">Real-time feed</div>
      </div>
    </div>

    <!-- ============================================================== -->
    <!--  Charts                                                         -->
    <!-- ============================================================== -->
    <div class="charts-row">
      <div class="chart-card">
        <h3>Alert Volume Over Time</h3>
        <div class="chart-wrapper"><canvas id="volumeChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Risk Score Distribution</h3>
        <div class="chart-wrapper"><canvas id="scoreChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Top Triggered Rules</h3>
        <div class="chart-wrapper"><canvas id="rulesChart"></canvas></div>
      </div>
    </div>

    <!-- ============================================================== -->
    <!--  Top Entities                                                   -->
    <!-- ============================================================== -->
    <div class="entities-row">
      <div class="entity-card">
        <h3>Top Suspicious Emails</h3>
        <table class="entity-table">
          <thead><tr><th>Email</th><th>Alerts</th></tr></thead>
          <tbody id="topEmails"><tr><td colspan="2" style="color:var(--text-muted)">Loading...</td></tr></tbody>
        </table>
      </div>
      <div class="entity-card">
        <h3>Top Suspicious IPs</h3>
        <table class="entity-table">
          <thead><tr><th>IP Address</th><th>Alerts</th></tr></thead>
          <tbody id="topIPs"><tr><td colspan="2" style="color:var(--text-muted)">Loading...</td></tr></tbody>
        </table>
      </div>
      <div class="entity-card">
        <h3>Top Suspicious BINs</h3>
        <table class="entity-table">
          <thead><tr><th>Card BIN</th><th>Alerts</th></tr></thead>
          <tbody id="topBINs"><tr><td colspan="2" style="color:var(--text-muted)">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- ============================================================== -->
    <!--  Alerts Queue                                                   -->
    <!-- ============================================================== -->
    <div class="alerts-section">
      <div class="alerts-header">
        <h2>Alerts Queue</h2>
        <div class="filter-bar">
          <label for="filterStatus">Status:</label>
          <select id="filterStatus">
            <option value="">All</option>
            <option value="NEEDS_REVIEW">Needs Review</option>
            <option value="INVESTIGATED">Investigated</option>
            <option value="CONFIRMED_FRAUD">Confirmed Fraud</option>
            <option value="CLEARED">Cleared</option>
          </select>
          <label for="filterRisk">Min Risk:</label>
          <input type="range" id="filterRisk" min="0" max="100" value="0" step="5">
          <span class="risk-slider-value" id="riskSliderValue">0</span>
          <button class="btn" id="btnRefresh" onclick="refreshAll()">Refresh</button>
        </div>
      </div>

      <div class="alerts-table-wrap">
        <table class="alerts-table">
          <thead>
            <tr>
              <th>Transaction ID</th>
              <th>Email</th>
              <th>Amount</th>
              <th>Payment</th>
              <th>Score</th>
              <th>Triggered Rules</th>
              <th>Time</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="alertsBody">
            <tr><td colspan="9" class="empty-state"><div class="spinner"></div><p>Loading alerts...</p></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ================================================================ -->
  <!--  Drill-Down Modal                                                 -->
  <!-- ================================================================ -->
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">Transaction Details</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Tabs -->
        <div class="modal-tabs">
          <button class="modal-tab active" data-tab="details" onclick="switchTab('details', this)">Details</button>
          <button class="modal-tab" data-tab="related-email" onclick="switchTab('related-email', this)">By Email</button>
          <button class="modal-tab" data-tab="related-ip" onclick="switchTab('related-ip', this)">By IP</button>
          <button class="modal-tab" data-tab="related-bin" onclick="switchTab('related-bin', this)">By BIN</button>
          <button class="modal-tab" data-tab="timeline" onclick="switchTab('timeline', this)">Timeline</button>
        </div>

        <!-- Details tab -->
        <div id="tab-details" class="modal-tab-content active">
          <div class="detail-grid" id="detailGrid">
            <div class="detail-item"><div class="detail-label">Loading...</div><div class="detail-value">--</div></div>
          </div>
        </div>

        <!-- Related by email -->
        <div id="tab-related-email" class="modal-tab-content">
          <table class="related-table">
            <thead><tr><th>Tx ID</th><th>Amount</th><th>Status</th><th>Time</th><th>Score</th></tr></thead>
            <tbody id="relatedEmailBody"><tr><td colspan="5" style="color:var(--text-muted)">Select a transaction</td></tr></tbody>
          </table>
        </div>

        <!-- Related by IP -->
        <div id="tab-related-ip" class="modal-tab-content">
          <table class="related-table">
            <thead><tr><th>Tx ID</th><th>Email</th><th>Amount</th><th>Status</th><th>Time</th></tr></thead>
            <tbody id="relatedIPBody"><tr><td colspan="5" style="color:var(--text-muted)">Select a transaction</td></tr></tbody>
          </table>
        </div>

        <!-- Related by BIN -->
        <div id="tab-related-bin" class="modal-tab-content">
          <table class="related-table">
            <thead><tr><th>Tx ID</th><th>Email</th><th>Amount</th><th>Status</th><th>Time</th></tr></thead>
            <tbody id="relatedBINBody"><tr><td colspan="5" style="color:var(--text-muted)">Select a transaction</td></tr></tbody>
          </table>
        </div>

        <!-- Timeline tab -->
        <div id="tab-timeline" class="modal-tab-content">
          <div class="timeline" id="timelineContainer">
            <div class="timeline-item">
              <div class="timeline-time">--</div>
              <div class="timeline-detail">Select a transaction to view its timeline</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================================================================ -->
  <!--  JavaScript                                                       -->
  <!-- ================================================================ -->
  <script>
    /* ---------------------------------------------------------------- */
    /*  State                                                            */
    /* ---------------------------------------------------------------- */
    const API_BASE = '';
    let ws = null;
    let wsConnected = false;
    let volumeChart = null;
    let scoreChart = null;
    let rulesChart = null;
    let alertsCache = [];
    let metricsRefreshTimer = null;

    /* ---------------------------------------------------------------- */
    /*  Utilities                                                        */
    /* ---------------------------------------------------------------- */
    function riskBadgeClass(score) {
      if (score >= 80) return 'risk-critical';
      if (score >= 70) return 'risk-high';
      if (score >= 40) return 'risk-medium';
      return 'risk-low';
    }

    function statusBadgeClass(status) {
      const map = {
        'NEEDS_REVIEW': 'status-needs-review',
        'INVESTIGATED': 'status-investigated',
        'CLEARED': 'status-cleared',
        'CONFIRMED_FRAUD': 'status-confirmed-fraud'
      };
      return map[status] || 'status-needs-review';
    }

    function formatTime(ts) {
      if (!ts) return '--';
      const d = new Date(ts);
      return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function formatDateTime(ts) {
      if (!ts) return '--';
      const d = new Date(ts);
      return d.toLocaleString('en-GB', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
    }

    function shortId(id) {
      if (!id) return '--';
      return id.substring(0, 8) + '...';
    }

    function updateTimestamp() {
      document.getElementById('lastUpdated').textContent =
        'Last updated: ' + new Date().toLocaleTimeString('en-GB');
    }

    function showError(msg) {
      const banner = document.getElementById('errorBanner');
      banner.textContent = msg || 'Unable to connect to the API server. Ensure uvicorn is running on localhost:8000.';
      banner.classList.add('visible');
    }

    function hideError() {
      document.getElementById('errorBanner').classList.remove('visible');
    }

    function showToast(title, body) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = '<div class="toast-title">' + escapeHtml(title) + '</div><div class="toast-body">' + escapeHtml(body) + '</div>';
      container.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 5000);
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    /* ---------------------------------------------------------------- */
    /*  WebSocket                                                        */
    /* ---------------------------------------------------------------- */
    function connectWebSocket() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = protocol + '//' + location.host + '/ws/alerts';

      try {
        ws = new WebSocket(wsUrl);
      } catch (e) {
        setWsStatus(false);
        return;
      }

      ws.onopen = function() {
        setWsStatus(true);
      };

      ws.onmessage = function(event) {
        try {
          const alert = JSON.parse(event.data);
          prependAlert(alert);
          updateKpiFromWs(alert);
          showToast('New Fraud Alert', 'Score: ' + alert.risk_score + ' | ' + (alert.transaction ? alert.transaction.customer_email : 'Unknown'));
        } catch (e) {
          // Ignore malformed messages
        }
      };

      ws.onclose = function() {
        setWsStatus(false);
        setTimeout(connectWebSocket, 5000);
      };

      ws.onerror = function() {
        setWsStatus(false);
      };
    }

    function setWsStatus(connected) {
      wsConnected = connected;
      const statusEl = document.getElementById('wsStatus');
      const dotEl = document.getElementById('wsDot');
      const labelEl = document.getElementById('wsLabel');
      const kpiWs = document.getElementById('kpiWsStatus');
      const kpiSub = document.getElementById('kpiWsSub');

      if (connected) {
        statusEl.className = 'live-indicator connected';
        dotEl.className = 'live-dot connected';
        labelEl.textContent = 'LIVE';
        kpiWs.textContent = 'Connected';
        kpiWs.style.color = 'var(--accent-green)';
        kpiSub.textContent = 'Receiving real-time alerts';
      } else {
        statusEl.className = 'live-indicator disconnected';
        dotEl.className = 'live-dot disconnected';
        labelEl.textContent = 'Disconnected';
        kpiWs.textContent = 'Disconnected';
        kpiWs.style.color = 'var(--accent-red)';
        kpiSub.textContent = 'Attempting reconnect...';
      }
    }

    function updateKpiFromWs(alert) {
      const totalEl = document.getElementById('kpiTotal');
      const current = parseInt(totalEl.textContent) || 0;
      totalEl.textContent = current + 1;

      if (alert.risk_score >= 80) {
        const hrEl = document.getElementById('kpiHighRisk');
        const hrCurrent = parseInt(hrEl.textContent) || 0;
        hrEl.textContent = hrCurrent + 1;
      }
    }

    /* ---------------------------------------------------------------- */
    /*  Fetch Alerts                                                     */
    /* ---------------------------------------------------------------- */
    async function fetchAlerts(status, minRisk) {
      try {
        const params = new URLSearchParams();
        if (status) params.set('status', status);
        if (minRisk > 0) params.set('min_risk', minRisk);
        params.set('hours', '24');

        const resp = await fetch(API_BASE + '/api/alerts?' + params.toString());
        if (!resp.ok) throw new Error('HTTP ' + resp.status);

        const alerts = await resp.json();
        alertsCache = alerts;
        renderAlerts(alerts);
        hideError();
      } catch (e) {
        showError('Failed to fetch alerts: ' + e.message);
        renderAlertsEmpty();
      }
    }

    function renderAlerts(alerts) {
      const tbody = document.getElementById('alertsBody');

      if (!alerts || alerts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><p>No alerts match the current filters.</p></td></tr>';
        return;
      }

      let html = '';
      for (const alert of alerts) {
        const tx = alert.transaction || {};
        const rules = alert.triggered_rules || [];
        const ruleTags = rules.map(r => '<span class="rule-tag">' + escapeHtml(r) + '</span>').join(' ');
        const badgeClass = riskBadgeClass(alert.risk_score);
        const statusClass = statusBadgeClass(alert.alert_status);

        html += '<tr onclick="openDrillDown(\'' + escapeHtml(tx.transaction_id || alert.transaction_id) + '\')">'
          + '<td class="mono">' + shortId(tx.transaction_id || alert.transaction_id) + '</td>'
          + '<td>' + escapeHtml(tx.customer_email || '--') + '</td>'
          + '<td class="mono">$' + (tx.amount_usd != null ? tx.amount_usd.toFixed(2) : '--') + '</td>'
          + '<td>' + escapeHtml(tx.payment_method || '--') + '</td>'
          + '<td><span class="risk-badge ' + badgeClass + '">' + alert.risk_score + '</span></td>'
          + '<td>' + ruleTags + '</td>'
          + '<td class="mono">' + formatTime(alert.created_at || tx.timestamp) + '</td>'
          + '<td><span class="status-badge ' + statusClass + '">' + escapeHtml(alert.alert_status || '--') + '</span></td>'
          + '<td>'
            + '<button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); updateStatus(\'' + escapeHtml(alert.alert_id) + '\', \'INVESTIGATED\')">Investigate</button> '
            + '<button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); updateStatus(\'' + escapeHtml(alert.alert_id) + '\', \'CONFIRMED_FRAUD\')">Confirm Fraud</button> '
            + '<button class="btn btn-sm btn-success" onclick="event.stopPropagation(); updateStatus(\'' + escapeHtml(alert.alert_id) + '\', \'CLEARED\')">Clear</button>'
          + '</td>'
          + '</tr>';
      }
      tbody.innerHTML = html;
    }

    function renderAlertsEmpty() {
      document.getElementById('alertsBody').innerHTML =
        '<tr><td colspan="9" class="empty-state"><p>Unable to load alerts. Is the API running?</p></td></tr>';
    }

    function prependAlert(alert) {
      const tbody = document.getElementById('alertsBody');
      const firstRow = tbody.firstElementChild;

      // Clear empty state if present
      if (firstRow && firstRow.querySelector('.empty-state')) {
        tbody.innerHTML = '';
      }

      const tx = alert.transaction || {};
      const rules = alert.triggered_rules || [];
      const ruleTags = rules.map(r => '<span class="rule-tag">' + escapeHtml(r) + '</span>').join(' ');
      const badgeClass = riskBadgeClass(alert.risk_score);
      const statusClass = statusBadgeClass(alert.alert_status);

      const tr = document.createElement('tr');
      tr.className = 'flash-new';
      tr.setAttribute('onclick', "openDrillDown('" + escapeHtml(tx.transaction_id || alert.transaction_id) + "')");
      tr.innerHTML =
          '<td class="mono">' + shortId(tx.transaction_id || alert.transaction_id) + '</td>'
        + '<td>' + escapeHtml(tx.customer_email || '--') + '</td>'
        + '<td class="mono">$' + (tx.amount_usd != null ? tx.amount_usd.toFixed(2) : '--') + '</td>'
        + '<td>' + escapeHtml(tx.payment_method || '--') + '</td>'
        + '<td><span class="risk-badge ' + badgeClass + '">' + alert.risk_score + '</span></td>'
        + '<td>' + ruleTags + '</td>'
        + '<td class="mono">' + formatTime(alert.created_at || tx.timestamp) + '</td>'
        + '<td><span class="status-badge ' + statusClass + '">' + escapeHtml(alert.alert_status || '--') + '</span></td>'
        + '<td>'
          + '<button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); updateStatus(\'' + escapeHtml(alert.alert_id) + '\', \'INVESTIGATED\')">Investigate</button> '
          + '<button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); updateStatus(\'' + escapeHtml(alert.alert_id) + '\', \'CONFIRMED_FRAUD\')">Confirm Fraud</button> '
          + '<button class="btn btn-sm btn-success" onclick="event.stopPropagation(); updateStatus(\'' + escapeHtml(alert.alert_id) + '\', \'CLEARED\')">Clear</button>'
        + '</td>';

      tbody.insertBefore(tr, tbody.firstElementChild);
      alertsCache.unshift(alert);
    }

    /* ---------------------------------------------------------------- */
    /*  Update Alert Status                                              */
    /* ---------------------------------------------------------------- */
    async function updateStatus(alertId, newStatus) {
      try {
        const resp = await fetch(API_BASE + '/api/alerts/' + alertId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ alert_status: newStatus })
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);

        // Re-fetch alerts to reflect changes
        const status = document.getElementById('filterStatus').value;
        const minRisk = parseInt(document.getElementById('filterRisk').value) || 0;
        await fetchAlerts(status, minRisk);
      } catch (e) {
        showToast('Action Failed', 'Could not update alert: ' + e.message);
      }
    }

    /* ---------------------------------------------------------------- */
    /*  Fetch Metrics                                                    */
    /* ---------------------------------------------------------------- */
    async function fetchMetrics() {
      try {
        const resp = await fetch(API_BASE + '/api/metrics');
        if (!resp.ok) throw new Error('HTTP ' + resp.status);

        const data = await resp.json();
        renderKPIs(data);
        renderVolumeChart(data);
        renderScoreChart(data);
        renderRulesChart(data);
        renderEntityTables(data);
        updateTimestamp();
        hideError();
      } catch (e) {
        showError('Failed to fetch metrics: ' + e.message);
      }
    }

    /* ---------------------------------------------------------------- */
    /*  Render KPIs                                                      */
    /* ---------------------------------------------------------------- */
    function renderKPIs(data) {
      document.getElementById('kpiTotal').textContent = data.total_alerts != null ? data.total_alerts : '--';
      document.getElementById('kpiHighRisk').textContent = data.high_risk_alerts != null ? data.high_risk_alerts : '--';

      const avg = data.avg_risk_score != null ? data.avg_risk_score.toFixed(1) : '--';
      document.getElementById('kpiAvgScore').textContent = avg;
    }

    /* ---------------------------------------------------------------- */
    /*  Charts                                                           */
    /* ---------------------------------------------------------------- */
    const chartDefaults = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
      },
      scales: {
        x: {
          ticks: { color: '#6b7280', font: { size: 11 } },
          grid: { color: 'rgba(46,51,72,0.5)' },
          border: { color: '#2e3348' }
        },
        y: {
          ticks: { color: '#6b7280', font: { size: 11 } },
          grid: { color: 'rgba(46,51,72,0.5)' },
          border: { color: '#2e3348' },
          beginAtZero: true
        }
      }
    };

    function renderVolumeChart(data) {
      const ctx = document.getElementById('volumeChart').getContext('2d');
      const hourly = data.alert_volume_hourly || {};
      const labels = Object.keys(hourly).sort();
      const values = labels.map(k => hourly[k]);

      if (volumeChart) volumeChart.destroy();

      volumeChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.map(l => l.includes('T') ? l.split('T')[1].substring(0, 5) : l),
          datasets: [{
            label: 'Alerts',
            data: values,
            borderColor: '#e74c3c',
            backgroundColor: 'rgba(231,76,60,0.1)',
            fill: true,
            tension: 0.35,
            pointBackgroundColor: '#e74c3c',
            pointRadius: 3,
            pointHoverRadius: 6,
            borderWidth: 2
          }]
        },
        options: {
          ...chartDefaults,
          plugins: {
            ...chartDefaults.plugins,
            tooltip: {
              backgroundColor: '#1a1d2e',
              titleColor: '#e8eaf0',
              bodyColor: '#9ca3af',
              borderColor: '#2e3348',
              borderWidth: 1,
              padding: 10
            }
          }
        }
      });
    }

    function renderScoreChart(data) {
      const ctx = document.getElementById('scoreChart').getContext('2d');
      const dist = data.risk_score_distribution || {};
      const labels = Object.keys(dist).sort();
      const values = labels.map(k => dist[k]);

      const colors = labels.map(l => {
        const n = parseInt(l) || 0;
        if (n >= 80) return '#e74c3c';
        if (n >= 70) return '#e67e22';
        if (n >= 40) return '#f39c12';
        return '#6b7280';
      });

      if (scoreChart) scoreChart.destroy();

      scoreChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Alerts',
            data: values,
            backgroundColor: colors.map(c => c + '99'),
            borderColor: colors,
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: chartDefaults
      });
    }

    function renderRulesChart(data) {
      const ctx = document.getElementById('rulesChart').getContext('2d');
      const rules = data.top_triggered_rules || {};
      const sorted = Object.entries(rules).sort((a, b) => b[1] - a[1]);
      const labels = sorted.map(e => e[0]);
      const values = sorted.map(e => e[1]);

      const ruleColors = [
        '#e74c3c', '#f39c12', '#3b82f6', '#8b5cf6', '#2ecc71',
        '#e67e22', '#06b6d4', '#ec4899'
      ];

      if (rulesChart) rulesChart.destroy();

      rulesChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Triggers',
            data: values,
            backgroundColor: labels.map((_, i) => ruleColors[i % ruleColors.length] + '80'),
            borderColor: labels.map((_, i) => ruleColors[i % ruleColors.length]),
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          ...chartDefaults,
          indexAxis: 'y',
          scales: {
            ...chartDefaults.scales,
            x: {
              ...chartDefaults.scales.x,
              beginAtZero: true
            },
            y: {
              ...chartDefaults.scales.y,
              ticks: { color: '#9ca3af', font: { size: 11 } }
            }
          }
        }
      });
    }

    /* ---------------------------------------------------------------- */
    /*  Entity Tables                                                    */
    /* ---------------------------------------------------------------- */
    function renderEntityTables(data) {
      renderEntityTable('topEmails', data.top_emails || []);
      renderEntityTable('topIPs', data.top_ips || []);
      renderEntityTable('topBINs', data.top_bins || []);
    }

    function renderEntityTable(elementId, entries) {
      const tbody = document.getElementById(elementId);

      if (!entries || entries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="color:var(--text-muted)">No data</td></tr>';
        return;
      }

      let html = '';
      for (const entry of entries.slice(0, 10)) {
        const label = entry.value || entry.email || entry.ip || entry.bin || entry[0] || '--';
        const count = entry.count || entry.alert_count || entry[1] || 0;
        html += '<tr>'
          + '<td>' + escapeHtml(String(label)) + '</td>'
          + '<td><span class="entity-count">' + count + '</span></td>'
          + '</tr>';
      }
      tbody.innerHTML = html;
    }

    /* ---------------------------------------------------------------- */
    /*  Drill-Down Modal                                                 */
    /* ---------------------------------------------------------------- */
    async function openDrillDown(txId) {
      const overlay = document.getElementById('modalOverlay');
      overlay.classList.add('active');

      document.getElementById('modalTitle').textContent = 'Transaction ' + shortId(txId);

      // Reset tabs
      switchTab('details', document.querySelector('.modal-tab[data-tab="details"]'));

      try {
        const resp = await fetch(API_BASE + '/api/transactions/' + txId + '/related');
        if (!resp.ok) throw new Error('HTTP ' + resp.status);

        const data = await resp.json();
        renderDrillDown(data);
      } catch (e) {
        document.getElementById('detailGrid').innerHTML =
          '<div class="detail-item" style="grid-column: 1/-1"><div class="detail-label">Error</div>'
          + '<div class="detail-value" style="color:var(--accent-red)">Failed to load transaction details: ' + escapeHtml(e.message) + '</div></div>';
      }
    }

    function renderDrillDown(data) {
      const tx = data.transaction || data;
      const related = data.related || {};

      // Details tab
      const fields = [
        { label: 'Transaction ID', value: tx.transaction_id },
        { label: 'Timestamp', value: formatDateTime(tx.timestamp) },
        { label: 'Customer Email', value: tx.customer_email },
        { label: 'Customer IP', value: tx.customer_ip },
        { label: 'Billing Country', value: tx.billing_country },
        { label: 'Shipping Country', value: tx.shipping_country },
        { label: 'Payment Method', value: tx.payment_method },
        { label: 'Card BIN', value: tx.card_bin || 'N/A' },
        { label: 'Amount (USD)', value: tx.amount_usd != null ? '$' + tx.amount_usd.toFixed(2) : '--' },
        { label: 'Status', value: tx.status },
        { label: 'Product Category', value: tx.product_category },
        { label: 'Quantity', value: tx.quantity },
        { label: 'Unit Price', value: tx.unit_price != null ? '$' + tx.unit_price.toFixed(2) : '--' },
        { label: 'Device Fingerprint', value: tx.device_fingerprint || 'N/A' },
        { label: 'First Purchase', value: tx.is_first_purchase ? 'Yes' : 'No' },
        { label: 'Risk Score', value: data.risk_score != null ? data.risk_score : '--' }
      ];

      let detailHtml = '';
      for (const f of fields) {
        detailHtml += '<div class="detail-item"><div class="detail-label">' + escapeHtml(f.label)
          + '</div><div class="detail-value">' + escapeHtml(String(f.value)) + '</div></div>';
      }
      document.getElementById('detailGrid').innerHTML = detailHtml;

      // Related by email
      renderRelatedTable('relatedEmailBody', related.by_email || [],
        ['transaction_id', 'amount_usd', 'status', 'timestamp', 'risk_score']);

      // Related by IP
      renderRelatedTable('relatedIPBody', related.by_ip || [],
        ['transaction_id', 'customer_email', 'amount_usd', 'status', 'timestamp']);

      // Related by BIN
      renderRelatedTable('relatedBINBody', related.by_bin || [],
        ['transaction_id', 'customer_email', 'amount_usd', 'status', 'timestamp']);

      // Timeline
      renderTimeline(data);
    }

    function renderRelatedTable(elementId, rows, columns) {
      const tbody = document.getElementById(elementId);
      if (!rows || rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="' + columns.length + '" style="color:var(--text-muted)">No related transactions found</td></tr>';
        return;
      }

      let html = '';
      for (const row of rows) {
        html += '<tr>';
        for (const col of columns) {
          let val = row[col];
          if (col === 'transaction_id') val = shortId(val);
          else if (col === 'amount_usd' && val != null) val = '$' + parseFloat(val).toFixed(2);
          else if (col === 'timestamp') val = formatTime(val);
          else if (val == null) val = '--';
          html += '<td>' + escapeHtml(String(val)) + '</td>';
        }
        html += '</tr>';
      }
      tbody.innerHTML = html;
    }

    function renderTimeline(data) {
      const container = document.getElementById('timelineContainer');
      const events = [];

      // Add the main transaction
      const tx = data.transaction || data;
      events.push({
        time: tx.timestamp,
        detail: 'Transaction ' + shortId(tx.transaction_id) + ' - $' +
          (tx.amount_usd != null ? tx.amount_usd.toFixed(2) : '?') +
          ' (' + (tx.status || '?') + ')'
      });

      // Add related events from email
      const related = data.related || {};
      const byEmail = related.by_email || [];
      for (const r of byEmail) {
        events.push({
          time: r.timestamp,
          detail: 'Related: ' + shortId(r.transaction_id) + ' - $' +
            (r.amount_usd != null ? parseFloat(r.amount_usd).toFixed(2) : '?') +
            ' (' + (r.status || '?') + ')'
        });
      }

      events.sort((a, b) => (a.time || '').localeCompare(b.time || ''));

      if (events.length === 0) {
        container.innerHTML = '<div class="timeline-item"><div class="timeline-time">--</div><div class="timeline-detail">No timeline data</div></div>';
        return;
      }

      let html = '';
      for (const ev of events) {
        html += '<div class="timeline-item">'
          + '<div class="timeline-time">' + formatDateTime(ev.time) + '</div>'
          + '<div class="timeline-detail">' + escapeHtml(ev.detail) + '</div>'
          + '</div>';
      }
      container.innerHTML = html;
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }

    function switchTab(tabId, btnEl) {
      // Deactivate all tabs
      document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.modal-tab-content').forEach(c => c.classList.remove('active'));

      // Activate selected
      btnEl.classList.add('active');
      const content = document.getElementById('tab-' + tabId);
      if (content) content.classList.add('active');
    }

    // Close modal on overlay click
    document.getElementById('modalOverlay').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });

    // Close modal on Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeModal();
    });

    /* ---------------------------------------------------------------- */
    /*  Filter Controls                                                  */
    /* ---------------------------------------------------------------- */
    document.getElementById('filterRisk').addEventListener('input', function() {
      document.getElementById('riskSliderValue').textContent = this.value;
    });

    document.getElementById('filterRisk').addEventListener('change', function() {
      const status = document.getElementById('filterStatus').value;
      const minRisk = parseInt(this.value) || 0;
      fetchAlerts(status, minRisk);
    });

    document.getElementById('filterStatus').addEventListener('change', function() {
      const minRisk = parseInt(document.getElementById('filterRisk').value) || 0;
      fetchAlerts(this.value, minRisk);
    });

    /* ---------------------------------------------------------------- */
    /*  Refresh & Init                                                   */
    /* ---------------------------------------------------------------- */
    function refreshAll() {
      fetchMetrics();
      const status = document.getElementById('filterStatus').value;
      const minRisk = parseInt(document.getElementById('filterRisk').value) || 0;
      fetchAlerts(status, minRisk);
    }

    // Auto-refresh metrics every 30 seconds
    function startAutoRefresh() {
      if (metricsRefreshTimer) clearInterval(metricsRefreshTimer);
      metricsRefreshTimer = setInterval(function() {
        fetchMetrics();
      }, 30000);
    }

    // Initialize on load
    window.addEventListener('DOMContentLoaded', function() {
      fetchMetrics();
      fetchAlerts('', 0);
      connectWebSocket();
      startAutoRefresh();
    });
  </script>
</body>
</html>
